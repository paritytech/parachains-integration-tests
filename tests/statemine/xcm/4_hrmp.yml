---
settings:
  chains:
    relay_chain: &relay_chain
      wsPort: 9900
    assets_parachain: &assets_parachain
      wsPort: 9910
      paraId: &ap_id 1000
      sovereign_account: &ap_sovereign F7fq1jSNVTPfJmaHaXCMtatT1EZefCUsa7rRiQVNR5efcah
    community_parachain: &community_parachain
      wsPort: 9920
      paraId: &cp_id 2000
      sovereign_account: &cp_sovereign F7fq1jMZkfuCuoMTyiEVAP2DMpMt18WopgBqTJznLihLNbZ
  variables:
    common:
      xcm_verison: &xcm_version 2
      amount: &amount 2000000000000
      require_weight_at_most: &weight_at_most 1000000000
    chains:
      relay_chain:
        signer: &rc_signer //Alice
        wallet: &rc_wallet HNZata7iMYWmk5RvZRTiAsSDhV8366zq2YGb3tLH5Upf74F
        assets_parachain_destination: &ap_dest { v1: { 0, interior: { x1: { parachain: *ap_id }}}}
        assets_parachain_account: &ap_acc '0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d'
        assets_parachain_beneficiary: &ap_benf {v1: { parents: 0, interior: { x1: { accountId32: { network: { any: true }, id: *ap_acc }}}}}
        ksm: &rc_ksm { concrete: { 0, interior: { here: true }}}
        ksm_fungible: &rc_ksm_fungible { id: *rc_ksm, fun: { fungible: *amount }}     
      assets_parachain_account:
        signer: &ap_signer //Alice
        wallet: &ap_wallet HNZata7iMYWmk5RvZRTiAsSDhV8366zq2YGb3tLH5Upf74F
        asset_id: &asset_id 2
        asset_min_balance: &asset_ed 1000 
        relay_chain_destination: &rc_dest { v1: { parents: 1, interior: { here: true }}}
        community_parachain_destination: &cp_dest { v1: { parents: 1, interior: { x1: { parachain: *cp_id } }}}
        community_parachain_sovereign_account: &cp_sovereign_acc FBeL7EAeUroLWXW1yfKboiqTqVfbRBcsUKd6QqVf4kGBySS
        assets_parachain_account: &rc_acc '0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d'
        relay_chain_beneficiary: &rc_benf {v1: { parents: 0, interior: { x1: { accountId32: { network: { any: true }, id: *rc_acc }}}}}
        ksm: &ap_ksm { concrete: { parents: 1, interior: { here: true }}}
        ksm_fungible: &ap_ksm_fungible { id: *ap_ksm, fun: { fungible: *amount }}
      community_parachain:
        signer: &cp_signer //Alice
        community_parachain_account: &cp_acc '0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d'
  decodedCalls:
    force_create_asset:
      chain: *assets_parachain
      pallet: assets
      call: forceCreate
      args: [
        *asset_id,
        { Id: *ap_wallet }, # owner
        true, # isSufficient
        *asset_ed # minBalance
      ]


tests:
  - name: HRMP
    describes:
      - name: polkadotXcm.limitedReserveTransferAssets (Asset) | Assets Parachain -> Community Parachain
        before:
          - name: DEPENDANCY | A sufficient Asset should exist in the Assets Parachain
            actions:
              - extrinsics:
                - chain: *relay_chain
                  signer: *rc_signer
                  sudo: true
                  pallet: xcmPallet
                  call: send
                  args: [ 
                    *ap_dest, # destination 
                    { 
                      v2: [ #message
                        { 
                          Transact: { 
                            originType: Superuser, 
                            requireWeightAtMost: *weight_at_most, 
                            call: $force_create_asset 
                          }
                        }
                      ]  
                    }
                  ]  
                  events:
                    - name: xcmPallet.Sent
                    - name: dmpQueue.ExecutedDownward
                      chain: *assets_parachain
                      attribute:
                        type: XcmV2TraitsOutcome
                        isComplete: true
                        value: 2,000,000,000
              - queries:
                  forced_created_asset:
                    chain: *assets_parachain
                    pallet: assets
                    call: asset
                    args: [ *asset_id ]
              - asserts:
                  custom:
                    path: ./asserts/checkAssetWasCreated.ts
                    args: $forced_created_asset

          - name: DEPENDANCY | Some Assets should be minted for the sender
            actions:
              - extrinsics:
                - chain: *assets_parachain
                  signer: *ap_signer
                  pallet: assets
                  call: mint
                  args: [ 
                    *asset_id,
                    *ap_wallet,
                    *amount
                  ]
                  events:
                    - name: assets.Issued
        its:
          - name: Assets Parachain should be able to reserve transfer an Asset to Community Parachain
            actions:
              - extrinsics:
                - chain: *assets_parachain
                  signer: *ap_signer
                  pallet: polkadotXcm
                  call: limitedReserveTransferAssets
                  args: [ 
                    *cp_dest, # destination
                    { # beneficiary
                      V1: {
                        parents: 0,
                        interior: {
                          X1: {
                            AccountId32: {
                              network: Any,
                              id: *cp_acc
                            }
                          }
                        }
                      }
                    },
                    { # assets
                      V1: [
                        {
                          id: {
                            Concrete: {
                              parents: 0,
                              interior: {
                                X2: [
                                  {
                                    PalletInstance: 50
                                  },
                                  {
                                    GeneralIndex: *asset_id
                                  }
                                ]
                              }
                            }
                          },
                          fun: {
                            Fungible: 500000000000
                          }
                        }
                      ]
                    },
                    0, # feeAssetItem
                    Unlimited # weightLimit
                  ]
                  events:
                    - name: polkadotXcm.Attempted
                      attributes:
                        type: XcmV2TraitsOutcome
                        isComplete: true
                        value: 1,000,000,000
                    - name: assets.Transferred
                      attributes:
                        type: AccountId32
                        value: *cp_sovereign_acc

                    # - name: ump.ExecutedUpward
                    #   chain: *relay_chain
                    #   attributes:
                    #     type: XcmV2TraitsOutcome
                    #     isComplete: true
                    #     value: 4,000,000

      # - name: hrmp.hrmpAcceptOpenChannel (Assets Parachain → Community Parachain) 
      #   its:              
      #     - name: Assets Parachain sends a response to the Relay Chain accepting the Community Parachain's request for openning a HRMP channel
      #       actions:
      #         - extrinsics:
      #           - chain: *relay_chain
      #             signer: *rc_signer
      #             sudo: true
      #             pallet: xcmPallet
      #             call: send
      #             args: [ 
      #               *ap_dest, # destination 
      #               { 
      #                 v2: [ #message
      #                   { 
      #                     Transact: { 
      #                       originType: Superuser, 
      #                       requireWeightAtMost: *weight_at_most, 
      #                       call: $xcm_accept_init_open_request_from_cp
      #                     }  
      #                   }
      #                 ] 
      #               }
      #             ]  
      #             events:
      #               - name: sudo.Sudid
      #                 attribute:
      #                   type: Result<Null, SpRuntimeDispatchError>
      #                   value: Ok
      #               - name: xcmPallet.Sent
      #               - name: dmpQueue.ExecutedDownward
      #                 chain: *assets_parachain
      #                 attribute:
      #                   type: XcmV2TraitsOutcome
      #                   isComplete: true
      #                   value: 2,000,000,000
      #               - name: polkadotXcm.Sent
      #                 chain: *assets_parachain
      #               - name: ump.ExecutedUpward
      #                 remote: true
      #                 timeout: 40000
      #                 attribute:
      #                   type: XcmV2TraitsOutcome
      #                   isComplete: true
      #                   value: 4,000,000,000
      #               - name: hrmp.OpenChannelAccepted
      #                 remote: true
      #                 timeout: 40000
      #         - queries:
      #             open_channels:
      #               chain: *relay_chain
      #               pallet: hrmp
      #               call: hrmpChannels
      #               args: [
      #                 {
      #                   sender: *cp_id,
      #                   recipient: *ap_id
      #                 }
      #               ]
      #         - asserts:
      #             equal:
      #               args: [
      #                 $open_channels,
      #                 *channel
      #               ]
      
      # - name: hrmp.hrmpInitOpenChannel (Assets Parachain → Community Parachain) 
      #   its:              
      #     - name: Assets Parchain sends a request to the Relay Chain to open a channel with a Community Parachain
      #       actions:
      #         - extrinsics:
      #           - chain: *relay_chain
      #             signer: *rc_signer
      #             sudo: true
      #             pallet: xcmPallet
      #             call: send
      #             args: [ 
      #               *ap_dest, # destination 
      #               { 
      #                 v2: [ #message
      #                   { 
      #                     Transact: { 
      #                       originType: Superuser, 
      #                       requireWeightAtMost: *weight_at_most, 
      #                       call: $xcm_init_open_channel_with_cp
      #                     }  
      #                   }
      #                 ] 
      #               }
      #             ]  
      #             events:
      #               - name: sudo.Sudid
      #                 attribute:
      #                   type: Result<Null, SpRuntimeDispatchError>
      #                   value: Ok
      #               - name: xcmPallet.Sent
      #               - name: dmpQueue.ExecutedDownward
      #                 chain: *assets_parachain
      #                 attribute:
      #                   type: XcmV2TraitsOutcome
      #                   isComplete: true
      #                   value: 2,000,000,000
      #               - name: polkadotXcm.Sent
      #                 chain: *assets_parachain
      #               - name: ump.ExecutedUpward
      #                 remote: true
      #                 timeout: 40000
      #                 attribute:
      #                   type: XcmV2TraitsOutcome
      #                   isComplete: true
      #                   value: 4,000,000,000
      #               - name: hrmp.OpenChannelRequested
      #                 remote: true
      #                 timeout: 40000
      #         - queries:
      #             requested_channels:
      #               chain: *relay_chain
      #               pallet: hrmp
      #               call: hrmpOpenChannelRequestsList
      #               args: []
      #         - asserts:
      #             equal:
      #               args: [
      #                 $requested_channels,
      #                 [
      #                   {
      #                     sender: *ap_id,
      #                     recipient: *cp_id
      #                   }
      #                 ]
      #               ]
      # - name: hrmp.hrmpAcceptOpenChannel (Community Parachain → Assets Parachain) 
      #   its:              
      #     - name: Community Parachain sends a response to the Relay Chain accepting the Assets Parachain's request for openning a HRMP channel
      #       actions:
      #         - extrinsics:
      #           - chain: *community_parachain
      #             signer: *cp_signer
      #             sudo: true
      #             pallet: polkadotXcm
      #             call: send
      #             args: [ 
      #               *rc_dest, # destination 
      #               { 
      #                 v2: [ #message
      #                   { 
      #                     WithdrawAsset: [*rc_ksm_fungible]
      #                   },
      #                   {
      #                     BuyExecution: {
      #                         fees: *rc_ksm_fungible,
      #                         weightLimit: Unlimited
      #                     }
      #                   },
      #                   {
      #                     Transact: {
      #                       originType: Native, 
      #                       requireWeightAtMost: *weight_at_most, 
      #                       call: $accept_open_channel_with_ap
      #                     }
      #                   }
      #                 ] 
      #               }
      #             ]  
      #             events:
      #               - name: sudo.Sudid
      #                 attribute:
      #                   type: Result<Null, SpRuntimeDispatchError>
      #                   value: Ok
      #               - name: polkadotXcm.Sent
      #               - name: ump.ExecutedUpward
      #                 chain: *relay_chain
      #                 attributes:
      #                   type: XcmV2TraitsOutcome
      #                   isComplete: true
      #                   value: 4,000,000
      #               - name: hrmp.OpenChannelAccepted
      #                 chain: *relay_chain


            
                                